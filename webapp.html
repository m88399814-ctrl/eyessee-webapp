<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —á–∞—Ç</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body {
      margin: 0;
      color: #fff;
    
      background-image: url("/static/bg.jpg");
      background-repeat: repeat-y;   /* ‚¨Ö –ø–æ–≤—Ç–æ—Ä –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
      background-size: auto;         /* ‚¨Ö –ù–ï —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º */
      background-position: top center;
    }
    #chat { padding:12px }
    .msg {
      margin:10px; /*–£–ú–ï–ù–¨–®–ò–¢–¨ –û–¢–°–¢–£–ü –ú–ï–ñ–î–£ –°–û–û–ë–©–ï–ù–ò–Ø–ú */
      padding:12px;/*–£–ú–ï–ù–¨–®–ò–¢–¨ –†–ê–ó–ú–ï–† –ö–í–ê–î–†–ê–¢–ê –ü–û –í–´–°–û–¢–ï, –ï–°–õ–ò –ü–ò–®–ï–ú –î–í–ê –ó–ù–ê–ß–ï–ù–ò–Ø –ó–ù–ê–ß–ò–¢ –ü–ï–†–í–ê–Ø –°–í–ï–†–•–£ –°–ù–ò–•–£, –ê –í–¢–û–†–ê–Ø –°–õ–ï–í–ê –°–ü–†–ê–í–ê*/
      border-radius:14px;
      max-width:70%; /*–£–ú–ï–ù–¨–®–ò–¢–¨ –ü–û –®–ò–†–ò–ù–ï */
      font-size:28px;   /* ‚Üê –¢–ï–ö–°–¢ –°–û–û–ë–©–ï–ù–ò–ô */
      line-height:1.4;
    }
    .me { background:#2b5278; margin-left:auto; text-align:right }
    .other { background:#1e1e1e }
    .name {
      font-size:30px;   /* ‚Üê –ò–ú–Ø */
      font-weight:600;
      opacity:.85;
      margin-bottom:6px;
    }
    .time {
      font-size:16px;   /* ‚Üê –í–†–ï–ú–Ø */
      opacity:.5;
      margin-top:6px;
    }
    .media {
      color:#5cc8ff;
      font-weight:bold;
      font-size:28px;   /* ‚Üê –ú–ï–î–ò–ê */
    }
  </style>
</head>

<body>
<h2 style="
  text-align:center;
  font-size:35px;
  padding:20px 0;
">
  üìÇ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —á–∞—Ç
</h2>
<div id="chat">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>

<script>
const chatEl = document.getElementById("chat");

// 1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º Telegram WebApp
const tg = window.Telegram?.WebApp;
if (!tg) {
  chatEl.innerHTML = "‚ùå –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram";
  console.warn("Telegram WebApp not found");
  return;
}

tg.expand();

// 2Ô∏è‚É£ –†–∞–∑–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
const params = new URLSearchParams(window.location.search);
const mode = params.get("mode");
const chatId = params.get("chat_id");

// 3Ô∏è‚É£ –ë–µ–∑–æ–ø–∞—Å–Ω–æ –±–µ—Ä—ë–º userId
const userId = tg.initDataUnsafe?.user?.id;
if (!userId) {
  chatEl.innerHTML = "‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è";
  console.warn("No user data");
  return;
}

// 4Ô∏è‚É£ MODE: COPY
if (mode === "copy") {
  chatEl.innerHTML = `
    <div style="text-align:center;padding:40px;font-size:28px">
      üìã –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤ –±–æ—Ç–µ, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
    </div>
  `;
  return;
}

// 5Ô∏è‚É£ MODE: RESTORE
if (mode !== "restore") {
  chatEl.innerHTML = "‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–µ–∂–∏–º";
  return;
}

if (!chatId) {
  chatEl.innerHTML = "‚ùå –ù–µ—Ç chat_id";
  return;
}

// 6Ô∏è‚É£ –ó–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç
fetch(`https://eyessee-webapp.html.onrender.com/api/chat?owner_id=${userId}&chat_id=${chatId}`)
  .then(r => r.json())
  .then(d => {
    if (!d.ok) {
      chatEl.innerHTML = "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏";
      return;
    }
  
    // üëá –í–ê–ñ–ù–û
    if (!d.messages || d.messages.length === 0) {
      chatEl.innerHTML = `
        <div style="opacity:.6; font-size:22px; padding:20px;">
          üì≠ –í —ç—Ç–æ–º —á–∞—Ç–µ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        </div>
      `;
      return;
    }
  
    chatEl.innerHTML = "";
  
    d.messages.forEach(m => {
      const isMine = m.is_owner === true;
  
      let html = `
        <div class="msg ${isMine ? "me" : "other"}">
          <div class="name">${m.name || ""}</div>
      `;
  
      if (m.type === "text") {
        html += `<div>${m.text || ""}</div>`;
      } else if (m.file_id) {
        html += `
          <a class="media" href="/api/file?file_id=${m.file_id}" target="_blank">
            üìé ${m.type}
          </a>
        `;
      } else {
        html += `<div class="media">‚ùå —Ñ–∞–π–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</div>`;
      }
  
      html += `<div class="time">${new Date(m.time).toLocaleString()}</div></div>`;
      chatEl.insertAdjacentHTML("beforeend", html);
    });
  })
  .catch(err => {
    chatEl.innerHTML = "‚ùå JS –æ—à–∏–±–∫–∞";
    console.error(err);
  });
</script>
</body>
</html>
