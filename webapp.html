<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —á–∞—Ç</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body {
      margin: 0;
      color: #fff;
    
      background-image: url("/static/bg.jpg");
      background-repeat: repeat-y;   /* ‚¨Ö –ø–æ–≤—Ç–æ—Ä –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
      background-size: auto;         /* ‚¨Ö –ù–ï —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º */
      background-position: top center;
    }
    #chat { padding:12px }
    .msg {
      margin:10px; /*–£–ú–ï–ù–¨–®–ò–¢–¨ –û–¢–°–¢–£–ü –ú–ï–ñ–î–£ –°–û–û–ë–©–ï–ù–ò–Ø–ú */
      padding:12px;/*–£–ú–ï–ù–¨–®–ò–¢–¨ –†–ê–ó–ú–ï–† –ö–í–ê–î–†–ê–¢–ê –ü–û –í–´–°–û–¢–ï, –ï–°–õ–ò –ü–ò–®–ï–ú –î–í–ê –ó–ù–ê–ß–ï–ù–ò–Ø –ó–ù–ê–ß–ò–¢ –ü–ï–†–í–ê–Ø –°–í–ï–†–•–£ –°–ù–ò–•–£, –ê –í–¢–û–†–ê–Ø –°–õ–ï–í–ê –°–ü–†–ê–í–ê*/
      border-radius:14px;
      max-width:70%; /*–£–ú–ï–ù–¨–®–ò–¢–¨ –ü–û –®–ò–†–ò–ù–ï */
      font-size:28px;   /* ‚Üê –¢–ï–ö–°–¢ –°–û–û–ë–©–ï–ù–ò–ô */
      line-height:1.4;
    }
    .me { background:#2b5278; margin-left:auto; text-align:right }
    .other { background:#1e1e1e }
    .name {
      font-size:30px;   /* ‚Üê –ò–ú–Ø */
      font-weight:600;
      opacity:.85;
      margin-bottom:6px;
    }
    .time {
      font-size:16px;   /* ‚Üê –í–†–ï–ú–Ø */
      opacity:.5;
      margin-top:6px;
    }
    .media {
      color:#5cc8ff;
      font-weight:bold;
      font-size:28px;   /* ‚Üê –ú–ï–î–ò–ê */
    }
  </style>
</head>

<body>
<h2 style="
  text-align:center;
  font-size:35px;
  padding:20px 0;
">
  üìÇ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —á–∞—Ç
</h2>
<div id="chat">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const params = new URLSearchParams(window.location.search);
const chatId = params.get("chat_id");
const userId = tg.initDataUnsafe.user.id;

fetch(`/api/chat?owner_id=${userId}&chat_id=${chatId}`)
  .then(r => r.json())
  .then(d => {
    if (!d.ok) {
      document.getElementById("chat").innerHTML = "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏";
      return;
    }

    const el = document.getElementById("chat");
    el.innerHTML = "";

    d.messages.forEach(m => {
      const isMine = m.is_owner === true;

      let html = `
        <div class="msg ${isMine ? "me" : "other"}">
          <div class="name">${m.name || ""}</div>
      `;

      if (m.type === "text") {
        html += `<div>${m.text || ""}</div>`;
      } else {
        if (!m.file_id) {
          html += `<div class="media">‚ùå —Ñ–∞–π–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</div>`;
        } else {
          html += `
            <a class="media"
               href="/api/file?file_id=${m.file_id}"
               target="_blank">
               üìé ${m.type}
            </a>
          `;
        }
      }

      html += `<div class="time">${new Date(m.time).toLocaleString()}</div></div>`;
      el.insertAdjacentHTML("beforeend", html);
    });
  })
  .catch(err => {
    document.getElementById("chat").innerHTML = "‚ùå JS –æ—à–∏–±–∫–∞";
    console.error(err);
  });
</script>
</body>
</html>
